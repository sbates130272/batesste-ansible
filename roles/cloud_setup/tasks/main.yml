---
# Copyright (c) Stephen Bates, 2022
#
# This role setups up the AWS and GitHub CLIs. Other CLIs may be added
# in time.

- name: Set a fact containing the current roles' path
  ansible.builtin.set_fact:
    calling_role_path_fact: "{{ role_path }}"

- name: Test the host platform to see if it can support this role
  ansible.builtin.include_role:
    name: check_platform
  vars:
    calling_role_path: "{{ calling_role_path_fact }}"

- name: Install packages for GitHub CLI and pip (for AWS CLI)
  ansible.builtin.package:
    update_cache: true
    state: present
    name:
      - gh
      - python3-pip
  become: true

# awscli was removed from Ubuntu 24.04 (noble) repos; install via pip
- name: Install AWS CLI via pip
  ansible.builtin.pip:
    name: awscli
    state: present
  become: true

- name: Ensure .aws folder exists
  ansible.builtin.file:
    dest: ~/.aws
    state: directory
    mode: "0755"

- name: Copy in AWS config
  ansible.builtin.copy:
    src: aws-config
    dest: ~/.aws/config
    mode: "0644"

- name: Template in AWS credentials
  ansible.builtin.template:
    src: aws-credentials.j2
    dest: ~/.aws/credentials
    mode: "0644"
