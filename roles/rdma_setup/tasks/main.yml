---
# Copyright (c) Stephen Bates, 2025
#
# RDMA setup

- name: Set a fact containing the current roles' path
  ansible.builtin.set_fact:
    calling_role_path_fact: "{{ role_path }}"

- name: Test the host platform to see if it can support this role
  ansible.builtin.include_role:
    name: check_platform
  vars:
    calling_role_path: "{{ calling_role_path_fact }}"

- name: Perform an update, upgrade and autoremove
  ansible.builtin.apt:
    update_cache: true
    upgrade: full
    autoremove: true
  become: true

- name: Perform a reboot to allow kernel updates
  ansible.builtin.reboot:
    reboot_timeout: "{{ rdma_setup_reboot_timeout }}"
  become: true
  when: ansible_connection != 'local'

- name: Update ansible_kernel as it may have changed
  ansible.builtin.setup:
    filter:
      - ansible_kernel

- name: Install the desired kernel packages
  ansible.builtin.package:
    update_cache: true
    name:
      - linux-headers-{{ ansible_kernel }}
      - linux-modules-extra-{{ ansible_kernel }}
  become: true

- name: Install the desired RDMA packages
  ansible.builtin.package:
    update_cache: true
    name:
      - ibutils
      - ibverbs-utils
      - infiniband-diags
      - librdmacm-dev
      - libibverbs-dev
      - libnl-3-dev
      - libnl-route-3-dev
      - libnuma-dev
      - numactl
      - perftest
      - rdma-core
      - rdmacm-utils
  become: true

- name: Update the PCIe ID tables (for new device support)
  ansible.builtin.shell:
    cmd: update-pciids
  become: true

- name: Run the rdma dev command and register output
  ansible.builtin.shell: rdma dev
  register: rdma_dev
  become: true

- name: Print the output of the rdma dev command
  ansible.builtin.debug:
    msg: "The rdma dev output was: {{ rdma_dev.stdout }}."
