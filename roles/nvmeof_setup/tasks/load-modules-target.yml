---
# Load kernel modules for NVMe-oF target

- name: Load NVMe-oF target kernel modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  become: true
  loop: "{{ nvmeof_setup_target_modules }}"

- name: Ensure modules load on boot
  ansible.builtin.lineinfile:
    path: /etc/modules-load.d/nvmeof-target.conf
    line: "{{ item }}"
    create: true
    mode: "0644"
  become: true
  loop: "{{ nvmeof_setup_target_modules }}"
  when: nvmeof_setup_persist_modules

- name: Ensure configfs is mounted
  ansible.posix.mount:
    path: /sys/kernel/config
    src: configfs
    fstype: configfs
    state: mounted
  become: true
