#!/bin/bash
# NVMe-oF Target Setup Script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -e

# Tear down any existing config so we can configure cleanly (idempotent start)
set +e
/usr/local/bin/nvmeof-target-cleanup.sh 2>/dev/null || true
set -e

# Wait for block devices (e.g. local NVMe) to appear before configuring namespaces
{% for dev in (nvmeof_setup_subsystems | map(attribute='namespaces') | flatten | map(attribute='device_path') | unique) %}
timeout=60
while [ ! -b {{ dev | quote }} ] && [ $timeout -gt 0 ]; do
    sleep 1
    timeout=$((timeout - 1))
done
if [ ! -b {{ dev | quote }} ]; then
    echo "Timeout waiting for block device {{ dev }}"
    exit 1
fi
{% endfor %}

# Load kernel modules
{% for module in nvmeof_setup_target_modules %}
modprobe {{ module }}
{% endfor %}

# Ensure configfs is mounted
mount -t configfs none /sys/kernel/config 2>/dev/null || true

{% for subsystem in nvmeof_setup_subsystems %}
# Create subsystem: {{ subsystem.name }}
if [ ! -d /sys/kernel/config/nvmet/subsystems/{{ subsystem.name }} ]; then
    mkdir -p /sys/kernel/config/nvmet/subsystems/{{ subsystem.name }}
fi

# Set allow_any_host
echo {{ '1' if subsystem.allow_any_host else '0' }} > \
    /sys/kernel/config/nvmet/subsystems/{{ subsystem.name }}/attr_allow_any_host

{% for ns in subsystem.namespaces %}
# Create namespace {{ ns.nsid }}
if [ ! -d /sys/kernel/config/nvmet/subsystems/{{ subsystem.name }}/namespaces/{{ ns.nsid }} ]; then
    mkdir -p /sys/kernel/config/nvmet/subsystems/{{ subsystem.name }}/namespaces/{{ ns.nsid }}
fi

# Configure namespace (set device_path only if not already set - writing when set causes I/O error)
ns_path="/sys/kernel/config/nvmet/subsystems/{{ subsystem.name }}/namespaces/{{ ns.nsid }}"
current_dev=$(cat "$ns_path/device_path" 2>/dev/null || true)
if [ "$current_dev" != "{{ ns.device_path }}" ]; then
    echo -n "{{ ns.device_path }}" > "$ns_path/device_path"
fi
echo {{ '1' if ns.enable else '0' }} > "$ns_path/enable"
{% endfor %}
{% endfor %}

{% for port in (nvmeof_setup_ports_resolved | default(nvmeof_setup_ports)) %}
# Create port {{ port.port_id }}
if [ ! -d /sys/kernel/config/nvmet/ports/{{ port.port_id }} ]; then
    mkdir -p /sys/kernel/config/nvmet/ports/{{ port.port_id }}
fi

# Unlink any subsystems so the kernel allows changing port attributes
port_subs="/sys/kernel/config/nvmet/ports/{{ port.port_id }}/subsystems"
if [ -d "$port_subs" ]; then
    for link in "$port_subs"/*; do
        [ -L "$link" ] && rm -f "$link"
    done
fi

# Configure port (must be done while port has no subsystems linked)
echo "{{ port.trtype }}" > \
    /sys/kernel/config/nvmet/ports/{{ port.port_id }}/addr_trtype
echo "{{ port.adrfam }}" > \
    /sys/kernel/config/nvmet/ports/{{ port.port_id }}/addr_adrfam
echo "{{ port.traddr }}" > \
    /sys/kernel/config/nvmet/ports/{{ port.port_id }}/addr_traddr
echo "{{ port.trsvcid }}" > \
    /sys/kernel/config/nvmet/ports/{{ port.port_id }}/addr_trsvcid

{% for subsystem_name in port.subsystems %}
# Link subsystem {{ subsystem_name }} to port {{ port.port_id }}
if [ ! -L /sys/kernel/config/nvmet/ports/{{ port.port_id }}/subsystems/{{ subsystem_name }} ]; then
    ln -s /sys/kernel/config/nvmet/subsystems/{{ subsystem_name }} \
        /sys/kernel/config/nvmet/ports/{{ port.port_id }}/subsystems/{{ subsystem_name }}
fi
{% endfor %}
{% endfor %}

echo "NVMe-oF target configuration completed successfully"

