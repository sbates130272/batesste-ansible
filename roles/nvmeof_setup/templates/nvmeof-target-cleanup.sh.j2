#!/bin/bash
# NVMe-oF Target Cleanup Script
# Generated by Ansible - DO NOT EDIT MANUALLY
# Tears down configfs NVMe-oF target so service stop is reversible.

set -e
shopt -s nullglob

BASE="/sys/kernel/config/nvmet"
[ -d "$BASE" ] || { echo "configfs nvmet not present"; exit 0; }

# Remove port subsystem links
for port_dir in "$BASE"/ports/*/; do
    [ -d "$port_dir" ] || continue
    for link in "$port_dir"subsystems/*; do
        [ -L "$link" ] && rm -f "$link"
    done
done

# Remove port directories
for port_dir in "$BASE"/ports/*/; do
    [ -d "$port_dir" ] && rmdir "$port_dir" 2>/dev/null || true
done

# Disable and remove namespaces
for sub_dir in "$BASE"/subsystems/*/; do
    [ -d "$sub_dir" ] || continue
    for ns_dir in "$sub_dir"namespaces/*/; do
        [ -d "$ns_dir" ] || continue
        echo 0 > "$ns_dir/enable" 2>/dev/null || true
        rmdir "$ns_dir" 2>/dev/null || true
    done
done

# Remove subsystems (skip discovery)
for sub_dir in "$BASE"/subsystems/*/; do
    [ -d "$sub_dir" ] || continue
    case "$(basename "$sub_dir")" in
        discovery) ;;
        *) rmdir "$sub_dir" 2>/dev/null || true ;;
    esac
done

echo "NVMe-oF target cleanup completed"
