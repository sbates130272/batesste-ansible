---
# Copyright (c) Stephen Bates, 2025
#
# Grafana, Prometheus, and Node Exporter setup

- name: Set a fact containing the current roles' path
  ansible.builtin.set_fact:
    calling_role_path_fact: "{{ role_path | default('') }}"

- name: Test the host platform to see if it can support this role
  ansible.builtin.include_role:
    name: check_platform
  vars:
    calling_role_path: "{{ calling_role_path_fact }}"
  when: calling_role_path_fact | length > 0

- name: Install required dependencies
  ansible.builtin.package:
    name:
      - apt-transport-https
      - software-properties-common
      - wget
      - curl
    state: present
    update_cache: true
  become: true

- name: Add Grafana GPG key
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      curl -fsSL https://apt.grafana.com/gpg.key | \
      gpg --dearmor -o /usr/share/keyrings/grafana-archive-keyring.gpg
    executable: /bin/bash
    creates: /usr/share/keyrings/grafana-archive-keyring.gpg
  become: true

- name: Add Grafana repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [signed-by=/usr/share/keyrings/grafana-archive-keyring.gpg]
      https://apt.grafana.com stable main
    state: present
    filename: grafana
  become: true

- name: Install Grafana
  ansible.builtin.package:
    name: grafana
    state: present
    update_cache: true
  become: true

- name: Create Grafana configuration directory
  ansible.builtin.file:
    path: /etc/grafana
    state: directory
    owner: grafana
    group: grafana
    mode: '0755'
  become: true

- name: Deploy Grafana configuration file
  ansible.builtin.template:
    src: grafana.ini.j2
    dest: /etc/grafana/grafana.ini
    owner: grafana
    group: grafana
    mode: '0640'
  become: true
  notify: Restart grafana

- name: Enable and start Grafana service
  ansible.builtin.systemd:
    name: grafana-server
    enabled: true
    state: started
    daemon_reload: true
  become: true

- name: Wait for Grafana to be ready
  ansible.builtin.uri:
    url: "http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/health"
    method: GET
    status_code: 200
  register: grafana_health
  until: grafana_health.status == 200
  retries: 30
  delay: 2
  changed_when: false

- name: Check if Grafana database exists
  ansible.builtin.stat:
    path: /var/lib/grafana/grafana.db
  register: grafana_db_stat
  become: true

- name: Reset admin password to match configuration
  ansible.builtin.command:
    cmd: >-
      grafana-cli admin reset-admin-password
      {{ grafana_setup_password }}
  become: true
  when: grafana_db_stat.stat.exists
  changed_when: true
  no_log: true

- name: Display password sync notice
  ansible.builtin.debug:
    msg:
      - "Note: Grafana admin password has been synchronized with configuration"
      - "Login with username 'admin' and the configured password"
  when: grafana_db_stat.stat.exists

- name: Check if additional user exists
  ansible.builtin.uri:
    url: >-
      http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/users/lookup?loginOrEmail={{ grafana_setup_user_login }}
    method: GET
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    status_code: [200, 404]
  register: grafana_user_check
  when: grafana_setup_create_user
  changed_when: false
  no_log: true

- name: Create additional Grafana user
  ansible.builtin.uri:
    url: "http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/admin/users"
    method: POST
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    body_format: json
    body:
      name: "{{ grafana_setup_user_name }}"
      email: "{{ grafana_setup_user_email }}"
      login: "{{ grafana_setup_user_login }}"
      password: "{{ grafana_setup_user_password }}"
      OrgId: 1
    status_code: [200, 201]
  when:
    - grafana_setup_create_user
    - grafana_user_check.status == 404
  no_log: true

- name: Update additional user's password if user exists
  ansible.builtin.uri:
    url: >-
      http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/admin/users/{{ grafana_user_check.json.id }}/password
    method: PUT
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    body_format: json
    body:
      password: "{{ grafana_setup_user_password }}"
    status_code: 200
  when:
    - grafana_setup_create_user
    - grafana_user_check.status == 200
  changed_when: true
  no_log: true

- name: Set additional user's role
  ansible.builtin.uri:
    url: >-
      http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/org/users/{{ grafana_user_check.json.id }}
    method: PATCH
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    body_format: json
    body:
      role: "{{ grafana_setup_user_role }}"
    status_code: 200
  when:
    - grafana_setup_create_user
    - grafana_user_check.status == 200
  changed_when: true

- name: Display additional user information
  ansible.builtin.debug:
    msg:
      - "Additional user created: {{ grafana_setup_user_login }}"
      - "Role: {{ grafana_setup_user_role }}"
  when:
    - grafana_setup_create_user

- name: Check if Prometheus datasource exists in Grafana
  ansible.builtin.uri:
    url: "http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/datasources/name/Prometheus"
    method: GET
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    status_code: [200, 404]
  register: grafana_prometheus_datasource_check
  when: grafana_setup_install_prometheus
  changed_when: false
  no_log: true

- name: Create Prometheus datasource in Grafana
  ansible.builtin.uri:
    url: "http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/datasources"
    method: POST
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    body_format: json
    body:
      name: Prometheus
      type: prometheus
      url: "http://localhost:{{ grafana_setup_prometheus_port }}"
      access: proxy
      isDefault: true
      jsonData:
        httpMethod: POST
        timeInterval: 30s
    status_code: [200, 201]
  when:
    - grafana_setup_install_prometheus
    - grafana_prometheus_datasource_check.status == 404
  register: grafana_datasource_created

- name: Update Prometheus datasource URL if it exists
  ansible.builtin.uri:
    url: >-
      http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/datasources/{{ grafana_prometheus_datasource_check.json.id }}
    method: PUT
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    body_format: json
    body:
      id: "{{ grafana_prometheus_datasource_check.json.id }}"
      uid: "{{ grafana_prometheus_datasource_check.json.uid }}"
      orgId: "{{ grafana_prometheus_datasource_check.json.orgId }}"
      name: Prometheus
      type: prometheus
      url: "http://localhost:{{ grafana_setup_prometheus_port }}"
      access: proxy
      isDefault: true
      jsonData:
        httpMethod: POST
        timeInterval: 30s
    status_code: 200
  when:
    - grafana_setup_install_prometheus
    - grafana_prometheus_datasource_check.status == 200
  changed_when: true

- name: Test Prometheus datasource connection
  ansible.builtin.uri:
    url: >-
      http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/datasources/name/Prometheus
    method: GET
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    status_code: 200
  register: grafana_datasource_test
  when: grafana_setup_install_prometheus
  changed_when: false
  no_log: true

- name: Display Prometheus datasource status
  ansible.builtin.debug:
    msg:
      - "Prometheus datasource configured successfully"
      - "Datasource ID: {{ grafana_datasource_test.json.id }}"
      - "URL: {{ grafana_datasource_test.json.url }}"
      - "Default: {{ grafana_datasource_test.json.isDefault }}"
  when:
    - grafana_setup_install_prometheus
    - grafana_datasource_test.json is defined

- name: Install Prometheus
  ansible.builtin.package:
    name: prometheus
    state: present
    update_cache: true
  become: true
  when: grafana_setup_install_prometheus

- name: Create Prometheus configuration directory
  ansible.builtin.file:
    path: /etc/prometheus
    state: directory
    owner: prometheus
    group: prometheus
    mode: '0755'
  become: true
  when: grafana_setup_install_prometheus

- name: Deploy Prometheus configuration file
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: /etc/prometheus/prometheus.yml
    owner: prometheus
    group: prometheus
    mode: '0644'
  become: true
  notify: Restart prometheus
  when: grafana_setup_install_prometheus

- name: Enable and start Prometheus service
  ansible.builtin.systemd:
    name: prometheus
    enabled: true
    state: started
    daemon_reload: true
  become: true
  when: grafana_setup_install_prometheus

- name: Install Node Exporter
  ansible.builtin.package:
    name: prometheus-node-exporter
    state: present
    update_cache: true
  become: true
  when: grafana_setup_install_node_exporter

- name: Enable and start Node Exporter service
  ansible.builtin.systemd:
    name: prometheus-node-exporter
    enabled: true
    state: started
    daemon_reload: true
  become: true
  when: grafana_setup_install_node_exporter

- name: Display Grafana access information
  ansible.builtin.debug:
    msg:
      - "Grafana: http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}"
      - "Username: admin"
      - "Password: (configured via vault_grafana_setup_password)"
      - >-
        Prometheus: http://localhost:{{ grafana_setup_prometheus_port }}
      - >-
        Exporter:
        http://localhost:{{ grafana_setup_node_exporter_port }}/metrics
