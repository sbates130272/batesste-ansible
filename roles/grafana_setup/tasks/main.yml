---
# Copyright (c) Stephen Bates, 2025
#
# Grafana, Prometheus, and Node Exporter setup

- name: Set a fact containing the current roles' path
  ansible.builtin.set_fact:
    calling_role_path_fact: "{{ role_path | default('') }}"

- name: Test the host platform to see if it can support this role
  ansible.builtin.include_role:
    name: check_platform
  vars:
    calling_role_path: "{{ calling_role_path_fact }}"
  when: calling_role_path_fact | length > 0

- name: Install required dependencies
  ansible.builtin.package:
    name:
      - apt-transport-https
      - software-properties-common
      - wget
      - curl
    state: present
    update_cache: true
  become: true

- name: Add Grafana GPG key
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      curl -fsSL https://apt.grafana.com/gpg.key | \
      gpg --dearmor -o /usr/share/keyrings/grafana-archive-keyring.gpg
    executable: /bin/bash
    creates: /usr/share/keyrings/grafana-archive-keyring.gpg
  become: true

- name: Add Grafana repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [signed-by=/usr/share/keyrings/grafana-archive-keyring.gpg]
      https://apt.grafana.com stable main
    state: present
    filename: grafana
  become: true

- name: Install Grafana
  ansible.builtin.package:
    name: grafana
    state: present
    update_cache: true
  become: true

- name: Create Grafana configuration directory
  ansible.builtin.file:
    path: /etc/grafana
    state: directory
    owner: grafana
    group: grafana
    mode: '0755'
  become: true

- name: Deploy Grafana configuration file
  ansible.builtin.template:
    src: grafana.ini.j2
    dest: /etc/grafana/grafana.ini
    owner: grafana
    group: grafana
    mode: '0640'
  become: true
  notify: Restart grafana

- name: Enable and start Grafana service
  ansible.builtin.systemd:
    name: grafana-server
    enabled: true
    state: started
    daemon_reload: true
  become: true

- name: Flush handlers to restart Grafana if config changed
  ansible.builtin.meta: flush_handlers

- name: Wait for Grafana to be ready
  ansible.builtin.uri:
    url: "http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/health"
    method: GET
    status_code: 200
  register: grafana_health
  until: grafana_health.status == 200
  retries: 30
  delay: 2
  changed_when: false

- name: Check if Grafana database exists
  ansible.builtin.stat:
    path: /var/lib/grafana/grafana.db
  register: grafana_db_stat
  become: true

- name: Reset admin password to match configuration
  ansible.builtin.command:
    cmd: >-
      grafana-cli admin reset-admin-password
      {{ grafana_setup_password }}
  become: true
  when: grafana_db_stat.stat.exists
  changed_when: true
  no_log: true

- name: Display password sync notice
  ansible.builtin.debug:
    msg:
      - "Note: Grafana admin password has been synchronized with configuration"
      - "Login with username 'admin' and the configured password"
  when: grafana_db_stat.stat.exists

- name: Check if additional user exists
  ansible.builtin.uri:
    url: >-
      http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/users/lookup?loginOrEmail={{ grafana_setup_user_login }}
    method: GET
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    status_code: [200, 404]
  register: grafana_user_check
  when: grafana_setup_create_user
  changed_when: false
  no_log: true

- name: Create additional Grafana user
  ansible.builtin.uri:
    url: "http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/admin/users"
    method: POST
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    body_format: json
    body:
      name: "{{ grafana_setup_user_name }}"
      email: "{{ grafana_setup_user_email }}"
      login: "{{ grafana_setup_user_login }}"
      password: "{{ grafana_setup_user_password }}"
      OrgId: 1
    status_code: [200, 201]
  when:
    - grafana_setup_create_user
    - grafana_user_check.status == 404
  no_log: true

- name: Update additional user's password if user exists
  ansible.builtin.uri:
    url: >-
      http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/admin/users/{{ grafana_user_check.json.id }}/password
    method: PUT
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    body_format: json
    body:
      password: "{{ grafana_setup_user_password }}"
    status_code: 200
  when:
    - grafana_setup_create_user
    - grafana_user_check.status == 200
  changed_when: true
  no_log: true

- name: Set additional user's role
  ansible.builtin.uri:
    url: >-
      http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/org/users/{{ grafana_user_check.json.id }}
    method: PATCH
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    body_format: json
    body:
      role: "{{ grafana_setup_user_role }}"
    status_code: 200
  when:
    - grafana_setup_create_user
    - grafana_user_check.status == 200
  changed_when: true

- name: Display additional user information
  ansible.builtin.debug:
    msg:
      - "Additional user created: {{ grafana_setup_user_login }}"
      - "Role: {{ grafana_setup_user_role }}"
  when:
    - grafana_setup_create_user

- name: Check if Prometheus datasource exists in Grafana
  ansible.builtin.uri:
    url: "http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/datasources/name/Prometheus"
    method: GET
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    status_code: [200, 404]
  register: grafana_prometheus_datasource_check
  when: grafana_setup_install_prometheus
  changed_when: false
  no_log: true

- name: Create Prometheus datasource in Grafana
  ansible.builtin.uri:
    url: "http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/datasources"
    method: POST
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    body_format: json
    body:
      name: Prometheus
      type: prometheus
      url: "http://localhost:{{ grafana_setup_prometheus_port }}"
      access: proxy
      isDefault: true
      jsonData:
        httpMethod: POST
        timeInterval: 30s
    status_code: [200, 201]
  when:
    - grafana_setup_install_prometheus
    - grafana_prometheus_datasource_check.status == 404
  register: grafana_datasource_created

- name: Update Prometheus datasource URL if it exists
  ansible.builtin.uri:
    url: >-
      http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/datasources/{{ grafana_prometheus_datasource_check.json.id }}
    method: PUT
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    body_format: json
    body:
      id: "{{ grafana_prometheus_datasource_check.json.id }}"
      uid: "{{ grafana_prometheus_datasource_check.json.uid }}"
      orgId: "{{ grafana_prometheus_datasource_check.json.orgId }}"
      name: Prometheus
      type: prometheus
      url: "http://localhost:{{ grafana_setup_prometheus_port }}"
      access: proxy
      isDefault: true
      jsonData:
        httpMethod: POST
        timeInterval: 30s
    status_code: 200
  when:
    - grafana_setup_install_prometheus
    - grafana_prometheus_datasource_check.status == 200
  changed_when: true

- name: Test Prometheus datasource connection
  ansible.builtin.uri:
    url: >-
      http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/datasources/name/Prometheus
    method: GET
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    status_code: 200
  register: grafana_datasource_test
  when: grafana_setup_install_prometheus
  changed_when: false
  no_log: true

- name: Display Prometheus datasource status
  ansible.builtin.debug:
    msg:
      - "Prometheus datasource configured successfully"
      - "Datasource ID: {{ grafana_datasource_test.json.id }}"
      - "URL: {{ grafana_datasource_test.json.url }}"
      - "Default: {{ grafana_datasource_test.json.isDefault }}"
  when:
    - grafana_setup_install_prometheus
    - grafana_datasource_test.json is defined

- name: Create Grafana provisioning directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: grafana
    group: grafana
    mode: '0755'
  become: true
  loop:
    - /etc/grafana/provisioning/dashboards
    - /var/lib/grafana/dashboards

- name: Create dashboard provisioning config
  ansible.builtin.copy:
    content: |
      apiVersion: 1
      providers:
        - name: 'Ansible Provisioned Dashboards'
          orgId: 1
          folder: ''
          type: file
          disableDeletion: false
          updateIntervalSeconds: 30
          allowUiUpdates: true
          options:
            path: /var/lib/grafana/dashboards
    dest: /etc/grafana/provisioning/dashboards/ansible-dashboards.yml
    owner: grafana
    group: grafana
    mode: '0644'
  become: true
  notify: Restart grafana

- name: Download Node Exporter dashboard from Grafana.com
  ansible.builtin.uri:
    url: >-
      https://grafana.com/api/dashboards/{{ grafana_setup_node_exporter_dashboard_id }}/revisions/latest/download
    method: GET
    return_content: true
    status_code: 200
  register: grafana_node_exporter_dashboard_download
  when:
    - grafana_setup_provision_node_exporter_dashboard
    - grafana_setup_install_node_exporter
  changed_when: false

- name: Get Prometheus datasource UID for dashboard
  ansible.builtin.uri:
    url: >-
      http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/datasources/name/Prometheus
    method: GET
    user: admin
    password: "{{ grafana_setup_password }}"
    force_basic_auth: true
    status_code: 200
  register: grafana_datasource_uid
  when:
    - grafana_setup_provision_node_exporter_dashboard
    - grafana_setup_install_node_exporter
  changed_when: false
  no_log: true

- name: Update dashboard datasource references
  ansible.builtin.set_fact:
    grafana_node_exporter_dashboard_updated: >-
      {{ grafana_node_exporter_dashboard_download.content | from_json |
         combine({'uid': 'node-exporter-full'}, recursive=True) |
         combine({'__inputs': []}, recursive=True) |
         to_json }}
  when:
    - grafana_setup_provision_node_exporter_dashboard
    - grafana_setup_install_node_exporter
    - grafana_node_exporter_dashboard_download.content is defined

- name: Provision Node Exporter dashboard
  ansible.builtin.copy:
    content: "{{ grafana_node_exporter_dashboard_updated }}"
    dest: /var/lib/grafana/dashboards/node-exporter-full.json
    owner: grafana
    group: grafana
    mode: '0644'
  become: true
  when:
    - grafana_setup_provision_node_exporter_dashboard
    - grafana_setup_install_node_exporter
    - grafana_node_exporter_dashboard_updated is defined
  notify: Restart grafana

- name: Display dashboard provisioning status
  ansible.builtin.debug:
    msg:
      - "Node Exporter Full dashboard provisioned"
      - "Dashboard ID: {{ grafana_setup_node_exporter_dashboard_id }}"
      - "Access at: http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/d/node-exporter-full"
  when:
    - grafana_setup_provision_node_exporter_dashboard
    - grafana_setup_install_node_exporter
    - grafana_node_exporter_dashboard_updated is defined

- name: Download AMD GPU dashboard from Grafana.com
  ansible.builtin.uri:
    url: >-
      https://grafana.com/api/dashboards/{{ grafana_setup_amd_gpu_dashboard_id }}/revisions/latest/download
    method: GET
    return_content: true
    status_code: 200
  register: grafana_amd_gpu_dashboard_download
  when: grafana_setup_provision_amd_gpu_dashboard
  changed_when: false

- name: Update AMD GPU dashboard datasource references
  ansible.builtin.set_fact:
    grafana_amd_gpu_dashboard_updated: >-
      {{ grafana_amd_gpu_dashboard_download.content | from_json |
         combine({'uid': 'amd-gpu-metrics'}, recursive=True) |
         combine({'__inputs': []}, recursive=True) |
         to_json }}
  when:
    - grafana_setup_provision_amd_gpu_dashboard
    - grafana_amd_gpu_dashboard_download.content is defined

- name: Provision AMD GPU dashboard
  ansible.builtin.copy:
    content: "{{ grafana_amd_gpu_dashboard_updated }}"
    dest: /var/lib/grafana/dashboards/amd-gpu-metrics.json
    owner: grafana
    group: grafana
    mode: '0644'
  become: true
  when:
    - grafana_setup_provision_amd_gpu_dashboard
    - grafana_amd_gpu_dashboard_updated is defined
  notify: Restart grafana

- name: Display AMD GPU dashboard provisioning status
  ansible.builtin.debug:
    msg:
      - "AMD GPU Metrics dashboard provisioned"
      - "Dashboard ID: {{ grafana_setup_amd_gpu_dashboard_id }}"
      - "Access at: http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/d/amd-gpu-metrics"
  when:
    - grafana_setup_provision_amd_gpu_dashboard
    - grafana_amd_gpu_dashboard_updated is defined

- name: Flush handlers to restart Grafana if dashboards changed
  ansible.builtin.meta: flush_handlers

- name: Wait for Grafana to be ready after dashboard provisioning
  ansible.builtin.uri:
    url: "http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}/api/health"
    method: GET
    status_code: 200
  register: grafana_health_after_dashboards
  until: grafana_health_after_dashboards.status == 200
  retries: 30
  delay: 2
  changed_when: false
  when: grafana_setup_provision_node_exporter_dashboard or grafana_setup_provision_amd_gpu_dashboard

- name: Install Node Exporter
  ansible.builtin.package:
    name: prometheus-node-exporter
    state: present
    update_cache: true
  become: true
  when: grafana_setup_install_node_exporter

- name: Enable and start Node Exporter service
  ansible.builtin.systemd:
    name: prometheus-node-exporter
    enabled: true
    state: started
    daemon_reload: true
  become: true
  when: grafana_setup_install_node_exporter

- name: Install nmap for network discovery
  ansible.builtin.package:
    name: nmap
    state: present
  become: true
  when: grafana_setup_discover_node_exporters or grafana_setup_discover_amd_gpu_exporters

- name: Scan local network for node exporters
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      timeout {{ grafana_setup_discovery_scan_timeout }} \
      nmap -p {{ grafana_setup_node_exporter_port }} \
      -T4 --max-retries 1 --host-timeout 2s \
      --open -oG - {{ grafana_setup_discovery_network }} \
      | grep '{{ grafana_setup_node_exporter_port }}/open' \
      | awk '{print $2}'
    executable: /bin/bash
  register: grafana_discovered_node_exporters
  changed_when: false
  when: grafana_setup_discover_node_exporters
  failed_when: false

- name: Verify discovered node exporters are responding
  ansible.builtin.uri:
    url: "http://{{ item }}:{{ grafana_setup_node_exporter_port }}/metrics"
    method: GET
    status_code: 200
    timeout: "{{ grafana_setup_discovery_timeout }}"
  loop: "{{ grafana_discovered_node_exporters.stdout_lines | default([]) }}"
  register: grafana_verified_exporters
  when:
    - grafana_setup_discover_node_exporters
    - grafana_discovered_node_exporters.stdout_lines is defined
    - grafana_discovered_node_exporters.stdout_lines | length > 0
  failed_when: false
  changed_when: false

- name: Build list of verified node exporter targets
  ansible.builtin.set_fact:
    grafana_verified_exporter_targets: >-
      {{ grafana_verified_exporters.results |
         default([]) |
         selectattr('status', 'defined') |
         selectattr('status', 'equalto', 200) |
         map(attribute='item') |
         list }}
  when:
    - grafana_setup_discover_node_exporters
    - grafana_verified_exporters.results is defined

- name: Display discovered node exporters
  ansible.builtin.debug:
    msg:
      - "Discovered {{ grafana_verified_exporter_targets | default([]) | length }} node exporter(s) on the network"
      - "Targets: {{ grafana_verified_exporter_targets | default([]) | join(', ') }}"
  when:
    - grafana_setup_discover_node_exporters
    - grafana_verified_exporter_targets is defined
    - grafana_verified_exporter_targets | length > 0

- name: Scan local network for AMD SMI exporters
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      timeout {{ grafana_setup_discovery_scan_timeout }} \
      nmap -p {{ grafana_setup_amd_gpu_exporter_port }} \
      -T4 --max-retries 1 --host-timeout 2s \
      --open -oG - {{ grafana_setup_discovery_network }} \
      | grep '{{ grafana_setup_amd_gpu_exporter_port }}/open' \
      | awk '{print $2}'
    executable: /bin/bash
  register: grafana_discovered_amd_gpu_exporters
  changed_when: false
  when: grafana_setup_discover_amd_gpu_exporters
  failed_when: false

- name: Verify discovered AMD SMI exporters are responding
  ansible.builtin.uri:
    url: "http://{{ item }}:{{ grafana_setup_amd_gpu_exporter_port }}/metrics"
    method: GET
    status_code: 200
    timeout: "{{ grafana_setup_discovery_timeout }}"
  loop: "{{ grafana_discovered_amd_gpu_exporters.stdout_lines | default([]) }}"
  register: grafana_verified_amd_gpu_exporters
  when:
    - grafana_setup_discover_amd_gpu_exporters
    - grafana_discovered_amd_gpu_exporters.stdout_lines is defined
    - grafana_discovered_amd_gpu_exporters.stdout_lines | length > 0
  failed_when: false
  changed_when: false

- name: Build list of verified AMD SMI exporter targets
  ansible.builtin.set_fact:
    grafana_verified_amd_gpu_targets: >-
      {{ grafana_verified_amd_gpu_exporters.results |
         default([]) |
         selectattr('status', 'defined') |
         selectattr('status', 'equalto', 200) |
         map(attribute='item') |
         list }}
  when:
    - grafana_setup_discover_amd_gpu_exporters
    - grafana_verified_amd_gpu_exporters.results is defined

- name: Display discovered AMD SMI exporters
  ansible.builtin.debug:
    msg:
      - "Discovered {{ grafana_verified_amd_gpu_targets | default([]) | length }} AMD SMI exporter(s) on the network"
      - "Targets: {{ grafana_verified_amd_gpu_targets | default([]) | join(', ') }}"
      - "Port: {{ grafana_setup_amd_gpu_exporter_port }}"
  when:
    - grafana_setup_discover_amd_gpu_exporters
    - grafana_verified_amd_gpu_targets is defined
    - grafana_verified_amd_gpu_targets | length > 0

- name: Install Prometheus
  ansible.builtin.package:
    name: prometheus
    state: present
    update_cache: true
  become: true
  when: grafana_setup_install_prometheus

- name: Create Prometheus configuration directory
  ansible.builtin.file:
    path: /etc/prometheus
    state: directory
    owner: prometheus
    group: prometheus
    mode: '0755'
  become: true
  when: grafana_setup_install_prometheus

- name: Deploy Prometheus configuration file
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: /etc/prometheus/prometheus.yml
    owner: prometheus
    group: prometheus
    mode: '0644'
  become: true
  notify: Restart prometheus
  when: grafana_setup_install_prometheus

- name: Enable and start Prometheus service
  ansible.builtin.systemd:
    name: prometheus
    enabled: true
    state: started
    daemon_reload: true
  become: true
  when: grafana_setup_install_prometheus

- name: Flush handlers to restart Prometheus if config changed
  ansible.builtin.meta: flush_handlers

- name: Display Grafana access information
  ansible.builtin.debug:
    msg:
      - "Grafana: http://{{ grafana_setup_domain }}:{{ grafana_setup_port }}"
      - "Username: admin"
      - "Password: (configured via vault_grafana_setup_password)"
      - >-
        Prometheus: http://localhost:{{ grafana_setup_prometheus_port }}
      - >-
        Exporter:
        http://localhost:{{ grafana_setup_node_exporter_port }}/metrics
