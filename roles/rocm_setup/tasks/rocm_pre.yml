- name: Copy the rocm-latest script to the host
  ansible.builtin.copy:
    src: rocm-latest
    dest: /usr/local/bin/rocm-latest
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Run the rocm-latest script and register results
  ansible.builtin.shell:
    cmd: rocm-latest
  environment:
    QUIET: "true"
    ONLY_ONE: ROCM
  register: rocm_latest_version

- name: Run the rocm-latest script and register results
  ansible.builtin.shell:
    cmd: rocm-latest
  environment:
    QUIET: "true"
    ONLY_ONE: AMDGPU
  register: amdgpu_latest_version

- name: Print the rocm package version
  ansible.builtin.debug:
    msg: "rocm latest_version: {{ rocm_latest_version.stdout }}"

- name: Print the amdgpu package version
  ansible.builtin.debug:
    msg: "amdgpu latest version: {{ amdgpu_latest_version.stdout }}"

- name: Populate rocm_setup_rocm_version variable
  ansible.builtin.set_fact:
    rocm_setup_rocm_version: "{{ rocm_latest_version.stdout }}"
  when: rocm_setup_rocm_version == 'latest'

- name: Populate rocm_setup_amdgpu_version variable
  ansible.builtin.set_fact:
    rocm_setup_amdgpu_version: "{{ amdgpu_latest_version.stdout }}"
  when: rocm_setup_amdgpu_version == 'latest'

- name: Fail if rocm_latest_version does not match rocm_setup_version (unless forced)
  ansible.builtin.fail:
    msg: "You are not requesting the latest rocm version!"
  when: rocm_latest_version.stdout != rocm_setup_rocm_version and not rocm_setup_version_force

- name: Fail if amdgpu_latest_version does not match rocm_setup_amdgpu_version (unless forced)
  ansible.builtin.fail:
    msg: "You are not requesting the latest amdgpu version!"
  when: amdgpu_latest_version.stdout != rocm_setup_amdgpu_version and not rocm_setup_version_force

- name: Perform an update, upgrade and autoremove
  ansible.builtin.apt:
    update_cache: true
    upgrade: full
    autoremove: true
  become: true

- name: Perform a reboot to allow kernel updates
  ansible.builtin.reboot:
    reboot_timeout: "{{ rocm_setup_reboot_timeout }}"
  become: true
  when: ansible_connection != 'local'

- name: Update ansible_kernel as it may have changed
  ansible.builtin.setup:
    filter:
      - ansible_kernel

- name: Install the prerequisite packages needed for ROCm install
  ansible.builtin.package:
    update_cache: true
    name:
      - linux-headers-{{ ansible_kernel }}
      - linux-modules-extra-{{ ansible_kernel }}
      - python3-setuptools
      - python3-wheel
  become: true

- name: Ensure the video and render groups exist
  ansible.builtin.group:
    name: "{{ item }}"
    state: present
  loop:
    - video
    - render
  become: true

- name: Ensure the requested user is a member of above groups
  ansible.builtin.user:
    name: "{{ rocm_setup_user }}"
    groups: "{{ item }}"
    append: true
  loop:
    - video
    - render
  become: true
