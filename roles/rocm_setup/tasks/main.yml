---
# Copyright (c) Stephen Bates, 2022
#
# AMD ROCm software install and setup.

- name: Set a fact containing the current roles' path
  ansible.builtin.set_fact:
    rocm_setup_calling_role_path_fact: "{{ role_path }}"

- name: Test the host platform to see if it can support this role
  ansible.builtin.include_role:
    name: check_platform
  vars:
    calling_role_path: "{{ rocm_setup_calling_role_path_fact }}"  # noqa var-naming

- name: Run the rocm_setup prerequisite steps
  ansible.builtin.import_tasks:
    file: rocm_pre.yml

- name: Ensure keyrings directory exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: true

- name: Install ROCm GPG key for ROCm repositories
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      wget -qO- https://repo.radeon.com/rocm/rocm.gpg.key \
        | gpg --dearmor \
        | tee /etc/apt/keyrings/rocm.gpg > /dev/null
  args:
    executable: /bin/bash
    creates: /etc/apt/keyrings/rocm.gpg
  become: true

- name: Write ROCm sources file
  ansible.builtin.template:
    src: rocm.sources.j2
    dest: "{{ rocm_setup_sources_file }}"
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Create a rocm-pin-600 file to pin the repos want to install
  ansible.builtin.copy:
    content: |
      Package: *
      Pin: release o=repo.radeon.com
      Pin-Priority: 600
    dest: /etc/apt/preferences.d/rocm-pin-600
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Update apt cache after ROCm repos
  ansible.builtin.apt:
    update_cache: true
  become: true

- name: Resolve ROCm meta package name
  ansible.builtin.set_fact:
    rocm_setup_rocm_meta_pkg: >-
      {{
        rocm_setup_versioned_package_map.get(
          rocm_setup_rocm_version | string | trim,
          'rocm'
        )
      }}

- name: Build ROCm package list
  ansible.builtin.set_fact:
    rocm_setup_packages: >-
      {{
        ['libstdc++-14-dev']
        + ([rocm_setup_rocm_meta_pkg] if not rocm_setup_wsl_install else [])
        + (['hsa-runtime-rocr4wsl-amdgpu', 'rocm-core', 'rocm-dev']
           if rocm_setup_wsl_install else [])
      }}

- name: Install ROCm packages
  ansible.builtin.package:
    update_cache: true
    name: "{{ rocm_setup_packages }}"
  become: true
  when: rocm_setup_packages | length > 0

- name: Update the library linker with rocm library paths
  ansible.builtin.copy:
    content: |
      /opt/rocm/lib
      /opt/rocm/lib64
    dest: /etc/ld.so.conf.d/rocm.conf
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Run ldconfig to ensure library updates take effect
  ansible.builtin.command:
    cmd: ldconfig
  become: true
  changed_when: false

- name: Update the PCIe ID tables (for new GPU support)
  ansible.builtin.command:
    cmd: update-pciids
  become: true
  failed_when: false
  changed_when: false

- name: Install or upgrade amdgpu-dkms to latest available  # noqa package-latest
  ansible.builtin.package:
    update_cache: true
    name:
      - amdgpu-dkms
    state: latest
  when: not rocm_setup_wsl_install
  become: true
  register: rocm_setup_amdgpu_dkms_install
  # Using latest is intentional: When installing multiple ROCm versions,
  # only one amdgpu-dkms can be installed and it must be the latest

- name: Display amdgpu-dkms version installed
  ansible.builtin.debug:
    msg: "amdgpu-dkms has been installed/upgraded"
  when: not rocm_setup_wsl_install and rocm_setup_amdgpu_dkms_install.changed

- name: Perform a reboot to allow changes to take effect
  ansible.builtin.reboot:
    reboot_timeout: "{{ rocm_setup_reboot_timeout }}"
  become: true
  when:
    - ansible_connection != 'local'
    - not rocm_setup_wsl_install
    - not rocm_setup_skip_reboot

- name: Run the rocm checks to ensure install worked
  ansible.builtin.import_tasks:
    file: rocm_check.yml
  when: rocm_setup_run_checks

- name: Install and configure AMD Device Metrics Exporter
  ansible.builtin.import_tasks:
    file: metrics_exporter.yml
  when: rocm_setup_install_metrics_exporter
