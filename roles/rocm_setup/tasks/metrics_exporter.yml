---
# Install and configure AMD Device Metrics Exporter for Prometheus metrics
# https://instinct.docs.amd.com/projects/device-metrics-exporter/
# en/latest/installation/deb-package.html

- name: Ensure metrics exporter prerequisites are installed
  ansible.builtin.package:
    name:
      - wget
      - gpg
    state: present
    update_cache: true
  become: true

- name: Ensure keyrings directory exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: true

- name: Install ROCm GPG key for metrics exporter
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      wget -qO- https://repo.radeon.com/rocm/rocm.gpg.key \
        | gpg --dearmor \
        | tee /etc/apt/keyrings/rocm.gpg > /dev/null
  args:
    executable: /bin/bash
    creates: /etc/apt/keyrings/rocm.gpg
  become: true

- name: Install AMD Device Metrics Exporter package
  ansible.builtin.package:
    name: amdgpu-exporter
    state: present
    update_cache: true
  become: true

- name: Ensure metrics exporter config directory exists
  ansible.builtin.file:
    path: "{{ rocm_setup_metrics_exporter_config_path | dirname }}"
    state: directory
    mode: '0755'
  become: true

- name: Write metrics exporter config
  ansible.builtin.template:
    src: metrics-config.json.j2
    dest: "{{ rocm_setup_metrics_exporter_config_path }}"
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Ensure amd-metrics-exporter services are enabled and started
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
    daemon_reload: true
  become: true
  loop:
    - amd-metrics-exporter.service
    - gpuagent.service
  failed_when: false

- name: Gather service facts
  ansible.builtin.service_facts:

- name: Open firewall port for AMD Device Metrics Exporter
  community.general.ufw:
    rule: allow
    port: "{{ rocm_setup_metrics_exporter_port }}"
    proto: tcp
    comment: AMD Device Metrics Exporter
  become: true
  when:
    - rocm_setup_metrics_exporter_open_firewall
    - ansible_facts.services['ufw.service'] is defined
    - ansible_facts.services['ufw.service'].state == 'running'
  failed_when: false

- name: Check if AMD Device Metrics Exporter service failed to start
  ansible.builtin.systemd:
    name: amd-metrics-exporter.service
  register: metrics_exporter_status
  become: true

- name: Display warning if exporter failed to start
  ansible.builtin.debug:
    msg:
      - "WARNING: AMD Device Metrics Exporter service failed to start"
      - "Possible reasons:"
      - "  - AMD kernel modules not loaded (try: modprobe amdgpu)"
      - "  - Insufficient permissions to access /dev/kfd or /dev/dri"
      - "  - ROCm libraries not properly installed"
      - "Check logs with: journalctl -u device-metrics-exporter -n 50"
  when:
    - metrics_exporter_status.status is defined
    - metrics_exporter_status.status.ActiveState != 'active'

- name: Wait for AMD Device Metrics Exporter to be ready
  ansible.builtin.wait_for:
    port: "{{ rocm_setup_metrics_exporter_port }}"
    delay: 2
    timeout: 30
  when:
    - rocm_setup_run_checks
    - metrics_exporter_status.status is defined
    - metrics_exporter_status.status.ActiveState == 'active'
  register: metrics_exporter_ready
  failed_when: false

- name: Verify AMD Device Metrics Exporter is responding
  ansible.builtin.uri:
    url: "http://localhost:{{ rocm_setup_metrics_exporter_port }}/metrics"
    method: GET
    status_code: 200
  register: metrics_exporter_health
  failed_when: false
  when:
    - rocm_setup_run_checks
    - metrics_exporter_ready is defined
    - metrics_exporter_ready is not skipped
    - metrics_exporter_ready is not failed

- name: Display AMD Device Metrics Exporter status
  ansible.builtin.debug:
    msg:
      - "âœ“ AMD Device Metrics Exporter is running"
      - "Listening on: {{ rocm_setup_metrics_exporter_port }}"
      - "Access from LAN: http://{{ ansible_default_ipv4.address }}:{{ rocm_setup_metrics_exporter_port }}/metrics"
      - ""
      - "Note: The exporter handles missing GPUs gracefully:"
      - "  - Version 1.3.1+: Omits unsupported/unavailable metrics"
      - "  - Older versions: Reports unavailable metrics as 0"
      - "  - Check logs for details: journalctl -u device-metrics-exporter"
  when:
    - rocm_setup_run_checks
    - metrics_exporter_health is defined
    - metrics_exporter_health.status is defined
    - metrics_exporter_health.status == 200
