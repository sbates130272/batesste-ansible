# AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
# Generated by generate-workflows.py for role: grafana_setup
# To regenerate: python3 .github/generate-workflows.py

name: grafana_setup CI
'on':
  workflow_dispatch: {}
  pull_request:
    branches:
      - main
    paths:
      - roles/grafana_setup/**
      - .github/workflows/**
      - requirements.txt
      - requirements.yml
  push:
    branches:
      - main
    paths:
      - roles/grafana_setup/**

jobs:
  grafana_setup-test:
    strategy:
      matrix:
        runs-on:
          - ubuntu-22.04
          - ubuntu-24.04
    runs-on: ${{ matrix.runs-on }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Install pip packages
        run: python3 -m pip install -r requirements.txt

      - name: Run ansible-galaxy to install collections and roles
        run: ansible-galaxy install -r requirements.yml

      - name: Create an SSH keypair
        run: mkdir -p .ssh && ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -q -N ""

      - name: Create a GNU PGP folder
        run: mkdir -p .gnupg

      - name: Write hosts-ci file
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: ./roles/grafana_setup/hosts-ci
          write-mode: overwrite
          contents: |
            all:
              hosts:
                localhost:
                  ansible_connection: local
                  ansible_user: runner
                  vault_grafana_setup_password: test_ci_password_123
                  grafana_setup_discover_node_exporters: false
                  grafana_setup_discover_amd_gpu_exporters: false

      - name: Run the test playbook against the local runner
        run: ansible-playbook -v -i hosts-ci ./tests/test.yml
        working-directory: ./roles/grafana_setup
        env:
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles
          ANSIBLE_VAULT_PASSWORD_FILE: ${{ github.workspace }}/playbooks/vault-env
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

      - name: Verify grafana_setup installation
        run: |
          systemctl status grafana-server || true
          systemctl status prometheus || true
          systemctl status prometheus-node-exporter || true
          curl -s http://localhost:3000/api/health || true
          curl -s http://localhost:9090/-/healthy || true
          curl -s http://localhost:9100/metrics | head -10 || true
