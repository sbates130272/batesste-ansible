# AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
# Generated by generate-workflows.py for role: nvmeof_setup
# To regenerate: python3 .github/generate-workflows.py

name: nvmeof_setup CI
'on':
  workflow_dispatch: {}

jobs:
  nvmeof_setup-test:
    continue-on-error: true
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Install pip packages
        run: python3 -m pip install -r requirements.txt

      - name: Run ansible-galaxy to install collections and roles
        run: ansible-galaxy install -r requirements.yml

      - name: Create an SSH keypair
        run: mkdir -p .ssh && ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -q -N ""

      - name: Create a GNU PGP folder
        run: mkdir -p .gnupg

      - name: Write hosts-ci file
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: ./roles/nvmeof_setup/hosts-ci
          write-mode: overwrite
          contents: |
            all:
              hosts:
                localhost:
                  ansible_connection: local
                  ansible_user: runner
                  nvmeof_setup_create_service: false
                  nvmeof_setup_cleanup: false

      - name: Run the test playbook against the local runner
        run: ansible-playbook -v -i hosts-ci ./tests/test.yml
        working-directory: ./roles/nvmeof_setup
        env:
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles

      - name: Verify nvmeof_setup installation
        run: |
          nvme version || true
          lsmod | grep nvme || true
          which nvme || true
          ls -la /sys/kernel/config/ || true
