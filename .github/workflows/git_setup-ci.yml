# AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
# Generated by generate-workflows.py for role: git_setup
# To regenerate: python3 .github/generate-workflows.py

name: git_setup CI
'on':
  workflow_dispatch: {}
  pull_request:
    branches:
      - main
    paths:
      - roles/git_setup/**
      - .github/workflows/**
      - requirements.txt
      - requirements.yml
  push:
    branches:
      - main
    paths:
      - roles/git_setup/**

jobs:
  git_setup-test:
    strategy:
      matrix:
        runs-on:
          - ubuntu-22.04
          - ubuntu-24.04
    runs-on: ${{ matrix.runs-on }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Install pip packages
        run: python3 -m pip install -r requirements.txt

      - name: Run ansible-galaxy to install collections and roles
        run: ansible-galaxy install -r requirements.yml

      - name: Create an SSH keypair
        run: mkdir -p .ssh && ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -q -N ""

      - name: Create a GNU PGP folder
        run: mkdir -p .gnupg

      - name: Write hosts-ci file
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: ./roles/git_setup/hosts-ci
          write-mode: overwrite
          contents: |
            all:
              hosts:
                localhost:
                  ansible_connection: local
                  ansible_user: runner
                  git_setup_enable_gpg_signing: false
                  git_setup_gh_authenticate: true

      - name: Run the test playbook against the local runner
        run: ansible-playbook -v -i hosts-ci ./tests/test.yml
        working-directory: ./roles/git_setup
        env:
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify git_setup installation
        run: |
          git --version
          gh --version
          git config --global --list
          gh auth status || true
