# AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
# Generated by generate-workflows.py for role: github_runner
# To regenerate: python3 .github/generate-workflows.py

name: github_runner CI
'on':
  workflow_dispatch: {}
  pull_request:
    branches:
      - main
    paths:
      - roles/github_runner/**
      - .github/workflows/**
      - requirements.txt
      - requirements.yml
  push:
    branches:
      - main
    paths:
      - roles/github_runner/**

jobs:
  github_runner-test:
    strategy:
      matrix:
        runs-on:
          - ubuntu-22.04
          - ubuntu-24.04
    runs-on: ${{ matrix.runs-on }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Install pip packages
        run: python3 -m pip install -r requirements.txt

      - name: Run ansible-galaxy to install collections and roles
        run: ansible-galaxy install -r requirements.yml

      - name: Create an SSH keypair
        run: mkdir -p .ssh && ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -q -N ""

      - name: Create a GNU PGP folder
        run: mkdir -p .gnupg

      - name: Write hosts-ci file
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: ./roles/github_runner/hosts-ci
          write-mode: overwrite
          contents: |
            all:
              hosts:
                localhost:
                  ansible_connection: local
                  ansible_user: runner
                  github_runner_url: https://github.com/sbates130272/batesste-ansible
                  github_runner_token: ''

      - name: Run the test playbook against the local runner
        run: ansible-playbook -v -i hosts-ci ./tests/test.yml
        working-directory: ./roles/github_runner
        env:
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles

      - name: Verify github_runner installation
        run: |
          id github-runner || true
          ls -la /opt/github-runner || true
          systemctl status github-runner || true
