# AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
# Generated by generate-workflows.py for role: rocm_setup
# To regenerate: python3 .github/generate-workflows.py

name: rocm_setup CI
'on':
  workflow_dispatch: {}
  pull_request:
    branches:
      - main
    paths:
      - roles/rocm_setup/**
      - .github/workflows/**
      - requirements.txt
      - requirements.yml
  push:
    branches:
      - main
    paths:
      - roles/rocm_setup/**

jobs:
  rocm_setup-test:
    runs-on: ubuntu-24.04
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Install pip packages
        run: python3 -m pip install -r requirements.txt

      - name: Run ansible-galaxy to install collections and roles
        run: ansible-galaxy install -r requirements.yml

      - name: Create an SSH keypair
        run: mkdir -p .ssh && ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -q -N ""

      - name: Create a GNU PGP folder
        run: mkdir -p .gnupg

      - name: Write hosts-ci file
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: ./roles/rocm_setup/hosts-ci
          write-mode: overwrite
          contents: |
            all:
              hosts:
                localhost:
                  ansible_connection: local
                  ansible_user: runner
                  rocm_setup_wsl_install: false
                  rocm_setup_rocm_version: latest
                  rocm_setup_amdgpu_version: latest
                  rocm_setup_run_checks: false

      - name: Run the test playbook against the local runner
        run: ansible-playbook -v -i hosts-ci ./tests/test.yml
        working-directory: ./roles/rocm_setup
        env:
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles
          ANSIBLE_VAULT_PASSWORD_FILE: ${{ github.workspace }}/playbooks/vault-env
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

      - name: Verify rocm_setup installation
        run: |
          systemctl status amdgpu-dkms || true
          dpkg -l | grep rocm || true
