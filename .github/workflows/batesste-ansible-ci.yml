name: batesste-ansible

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

jobs:

  build-spellcheck-lint-test:
    strategy:
      matrix:
        runs-on: [ubuntu-22.04, ubuntu-24.04]
    runs-on: ${{ matrix.runs-on }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2
      - name: Setup python and pip
        uses: actions/setup-python@v5.3.0
        with:
          python-version: '3.12.3'
      - name: Install pip packages
        run: python3 -m pip install -r requirements.txt
      - name: GitHub spellcheck action
        uses: rojopolis/spellcheck-github-actions@0.45.0
      - name: Render the checkout directory safe for the lint step
        run: git config --global --add safe.directory /github/workspace
      - name: Run ansible-galaxy to install collections and roles
        run: ansible-galaxy install -r requirements.yml
      - name: Run ansible-lint
        uses: ansible/ansible-lint@v25.8.2
        with:
          args: "-c .ansible-lint"
          setup_python: "false"
      - name: Create an SSH keypair
        run: mkdir -p .ssh && ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -q -N ""
      - name: Create a GNU PGP folder
        run: mkdir -p .gnupg
      - name: Write hosts-ci file
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: ./playbooks/hosts-ci
          write-mode: overwrite
          contents: |
            [locals]
            [runners]
            localhost root_user=runner username=runner ansible_connection=local
            [awsmachines]
            [localvms]
      - name: Run the default playbook against the local runner
        run: ansible-playbook ${PLAYBOOK} -v -i ${HOSTS} --extra-vars targets=${TARGETS}
        working-directory: ./playbooks
        env:
          PLAYBOOK: setup-newmachine.yml
          TARGETS: runners
          HOSTS: hosts-ci
          ANSIBLE_VAULT_PASSWORD_FILE: ./vault-env
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

  rocm_setup-role-test:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        wsl_install: [ false, true ]
        include:
          - rocm_version: latest
            wsl_install: false
          - rocm_version: 6.4.4
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
      - name: Checkout code
        uses: actions/checkout@v4.2.2
      - name: Install pip packages
        run: python3 -m pip install -r requirements.txt
      - name: Run ansible-galaxy to install collections and roles
        run: ansible-galaxy install -r requirements.yml
      - name: Create an SSH keypair
        run: mkdir -p .ssh && ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -q -N ""
      - name: Create a GNU PGP folder
        run: mkdir -p .gnupg
      - name: Write hosts-ci file
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: ./roles/rocm_setup/hosts-ci
          write-mode: overwrite
          contents: |
            hosts:
              runners:
                localhost:
                  rocm_setup_wsl_install: ${{ matrix.wsl_install }}
                  rocm_setup_rocm_version: ${{ matrix.rocm_version }}
                  rocm_setup_amdgpu_version: ${ matrix.rocm_version }}
                  rocm_setup_version_force: ${{ matrix.wsl_install }}
                  rocm_setup_run_checks: false
              vars:
                ansible_connection: local
                ansible_user: runner
                root_user: runner
                username: runner
      - name: Run the test playbook against the local runner
        run: ansible-playbook -v -i hosts-ci ./tests/test.yml --limit runners
        working-directory: ./roles/rocm_setup
        env:
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles
          ANSIBLE_VAULT_PASSWORD_FILE: ${{ github.workspace }}/playbooks/vault-env
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

  rocm_setup-multi-version-test:
    runs-on: ubuntu-24.04
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
      - name: Checkout code
        uses: actions/checkout@v4.2.2
      - name: Install pip packages
        run: python3 -m pip install -r requirements.txt
      - name: Run ansible-galaxy to install collections and roles
        run: ansible-galaxy install -r requirements.yml
      - name: Create an SSH keypair
        run: mkdir -p .ssh && ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -q -N ""
      - name: Create a GNU PGP folder
        run: mkdir -p .gnupg
      - name: Write hosts-ci file for latest version install
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: ./roles/rocm_setup/hosts-ci-latest
          write-mode: overwrite
          contents: |
            all:
              hosts:
                localhost:
                  ansible_connection: local
                  ansible_user: runner
                  rocm_setup_wsl_install: false
                  rocm_setup_rocm_version: latest
                  rocm_setup_amdgpu_version: latest
                  rocm_setup_add_new: false
                  rocm_setup_run_checks: false
      - name: Install latest ROCm version
        run: ansible-playbook -v -i hosts-ci-latest ./tests/test.yml
        working-directory: ./roles/rocm_setup
        env:
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles
          ANSIBLE_VAULT_PASSWORD_FILE: ${{ github.workspace }}/playbooks/vault-env
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      - name: Verify latest ROCm installation
        run: |
          rocminfo || true
          dpkg -l | grep rocm || true
      - name: Write hosts-ci file for adding ROCm 6.3.0
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: ./roles/rocm_setup/hosts-ci-6.3
          write-mode: overwrite
          contents: |
            all:
              hosts:
                localhost:
                  ansible_connection: local
                  ansible_user: runner
                  rocm_setup_wsl_install: false
                  rocm_setup_rocm_version: 6.3.0
                  rocm_setup_amdgpu_version: 6.3
                  rocm_setup_add_new: true
                  rocm_setup_force_version: true
                  rocm_setup_run_checks: false
      - name: Add ROCm 6.3.0 alongside latest
        run: ansible-playbook -v -i hosts-ci-6.3 ./tests/test.yml
        working-directory: ./roles/rocm_setup
        env:
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles
          ANSIBLE_VAULT_PASSWORD_FILE: ${{ github.workspace }}/playbooks/vault-env
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      - name: Write hosts-ci file for adding ROCm 6.2.0
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: ./roles/rocm_setup/hosts-ci-6.2
          write-mode: overwrite
          contents: |
            all:
              hosts:
                localhost:
                  ansible_connection: local
                  ansible_user: runner
                  rocm_setup_wsl_install: false
                  rocm_setup_rocm_version: 6.2.0
                  rocm_setup_amdgpu_version: 6.2
                  rocm_setup_add_new: true
                  rocm_setup_force_version: true
                  rocm_setup_run_checks: false
      - name: Add ROCm 6.2.0 alongside others
        run: ansible-playbook -v -i hosts-ci-6.2 ./tests/test.yml
        working-directory: ./roles/rocm_setup
        env:
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles
          ANSIBLE_VAULT_PASSWORD_FILE: ${{ github.workspace }}/playbooks/vault-env
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      - name: Verify all three ROCm versions are installed
        run: |
          echo "=== Checking for multiple ROCm versions ==="
          dpkg -l | grep rocm || true
          echo "=== Checking ROCm repositories ==="
          ls -la /etc/apt/sources.list.d/ | grep rocm || true
          echo "=== Checking installed rocm packages ==="
          apt list --installed | grep rocm || true
          echo "=== Checking amdgpu-dkms version ==="
          dpkg -l | grep amdgpu-dkms || true
          echo "=== Verifying rocm package counts ==="
          dpkg -l | grep -c "^ii.*rocm" || true

  grafana_setup-role-test:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2
      - name: Install pip packages
        run: python3 -m pip install -r requirements.txt
      - name: Run ansible-galaxy to install collections and roles
        run: ansible-galaxy install -r requirements.yml
      - name: Create an SSH keypair
        run: mkdir -p .ssh && ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -q -N ""
      - name: Create a GNU PGP folder
        run: mkdir -p .gnupg
      - name: Write hosts-ci file
        uses: DamianReeves/write-file-action@v1.3
        with:
          path: ./roles/grafana_setup/hosts-ci
          write-mode: overwrite
          contents: |
            all:
              hosts:
                localhost:
                  ansible_connection: local
                  ansible_user: runner
                  vault_grafana_setup_password: test_ci_password_123
      - name: Run the test playbook against the local runner
        run: ansible-playbook -v -i hosts-ci ./tests/test.yml
        working-directory: ./roles/grafana_setup
        env:
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles
          ANSIBLE_VAULT_PASSWORD_FILE: ${{ github.workspace }}/playbooks/vault-env
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      - name: Verify Grafana installation
        run: |
          echo "=== Checking Grafana service ==="
          systemctl status grafana-server || true
          echo "=== Checking Grafana version ==="
          grafana-server -v || true
          echo "=== Checking Grafana is listening ==="
          ss -tlnp | grep 3000 || true
      - name: Verify Prometheus installation
        run: |
          echo "=== Checking Prometheus service ==="
          systemctl status prometheus || true
          echo "=== Checking Prometheus is listening ==="
          ss -tlnp | grep 9090 || true
      - name: Verify Node Exporter installation
        run: |
          echo "=== Checking Node Exporter service ==="
          systemctl status prometheus-node-exporter || true
          echo "=== Checking Node Exporter is listening ==="
          ss -tlnp | grep 9100 || true
          echo "=== Testing Node Exporter metrics ==="
          curl -s http://localhost:9100/metrics | head -20 || true
